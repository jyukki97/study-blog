{{ define "main" }}
{{- $modules := where site.RegularPages "Params.module_key" "!=" nil }}
{{- $modules = where $modules "Section" "learning" }}
{{- $modules = where $modules "File.Dir" "==" "learning/modules/" }}
{{- $modules = sort $modules "Weight" }}
<div class="learning-container">
  <header class="learning-hero">
    <div class="hero-content">
      <div class="hero-icon">ğŸ§­</div>
      <h1 class="hero-title">{{ .Title }}</h1>
      <p class="hero-description">{{ .Description }}</p>
      <div class="hero-actions">
        <a class="hero-btn ghost" href="/learning/">Learning ë©”ì¸</a>
      </div>
    </div>
    <div class="hero-background">
      <div class="floating-element"></div>
      <div class="floating-element"></div>
      <div class="floating-element"></div>
    </div>
  </header>

  <section class="learning-timeline">
    <div class="section-header">
      <h2>ğŸ“‘ í•™ìŠµ íƒ€ì„ë¼ì¸</h2>
      <div class="section-line"></div>
      <div class="timeline-controls">
        <button type="button" class="timeline-control" data-action="expand">ì „ì²´ í¼ì¹˜ê¸°</button>
        <button type="button" class="timeline-control" data-action="collapse">ì „ì²´ ì ‘ê¸°</button>
      </div>
    </div>
    {{- if gt (len $modules) 0 }}
    <nav class="timeline-nav" aria-label="ëª¨ë“ˆ ë°”ë¡œê°€ê¸°">
      {{- range $modules }}
      {{- $moduleKey := .Params.module_key }}
      {{- $navPosts := where site.RegularPages "Params.module" $moduleKey }}
      {{- $navPosts = where $navPosts "Params.study_order" "!=" nil }}
      {{- $navPosts = sort $navPosts "Params.study_order" }}
      <a class="timeline-nav-item" href="#module-{{ $moduleKey }}">
        <span class="nav-step">STEP {{ .Weight }}</span>
        <span class="nav-title">{{ .Title }}</span>
        <span class="nav-count">{{ len $navPosts }}ê°œ</span>
      </a>
      {{- end }}
    </nav>
    {{- end }}
    {{- if gt (len $modules) 0 }}
    <div class="timeline-list grouped">
      {{- range $modules }}
      {{- $moduleKey := .Params.module_key }}
      {{- $modulePosts := where site.RegularPages "Params.module" $moduleKey }}
      {{- $modulePosts = where $modulePosts "Params.study_order" "!=" nil }}
      {{- $modulePosts = sort $modulePosts "Params.study_order" }}
      {{- $isCollapsed := and (gt (len $modulePosts) 0) (ne .Weight 1) }}
      <div class="timeline-step{{ if $isCollapsed }} is-collapsed{{ end }}" data-module="{{ $moduleKey }}">
        <article id="module-{{ $moduleKey }}" class="timeline-item module-head">
          <div class="timeline-order">STEP {{ .Weight }}</div>
          <div class="timeline-body">
            <div class="module-head-row">
              <h3 class="timeline-title"><a href="{{ .Permalink }}">{{ .Title }}</a></h3>
              <div class="module-head-meta">
                <span class="module-count">{{ len $modulePosts }}ê°œ</span>
                {{- if gt (len $modulePosts) 0 }}
                <button type="button" class="module-toggle"
                  aria-expanded="{{ if $isCollapsed }}false{{ else }}true{{ end }}"
                  aria-controls="module-posts-{{ $moduleKey }}">
                  {{- if $isCollapsed }}í¼ì¹˜ê¸°{{ else }}ì ‘ê¸°{{ end -}}
                </button>
                {{- end }}
              </div>
            </div>
            <p class="timeline-desc">
              {{- with .Params.description }}{{ . }}{{- else }}{{ .Summary | plainify | truncate 140 }}{{- end }}
            </p>
            {{- if and (eq (len $modulePosts) 0) (eq $moduleKey "overview") }}
            <p class="module-note">ì´ ë‹¨ê³„ëŠ” ì „ì²´ íë¦„ ì•ˆë‚´ì…ë‹ˆë‹¤. ì•„ë˜ STEP 1ë¶€í„° ìˆœì„œëŒ€ë¡œ ì§„í–‰í•˜ë©´ ë©ë‹ˆë‹¤.</p>
            {{- end }}
            {{- if and (eq (len $modulePosts) 0) (eq $moduleKey "qna") }}
            <p class="module-note">Q&AëŠ” ë³µìŠµìš©ì´ë¼ íƒ€ì„ë¼ì¸ ë²ˆí˜¸ ì—†ì´ ëª¨ë“ˆ í˜ì´ì§€ì—ì„œ ìµœì‹ ìˆœìœ¼ë¡œ ì •ë¦¬ë©ë‹ˆë‹¤.</p>
            {{- end }}
          </div>
        </article>
        {{- if gt (len $modulePosts) 0 }}
        <div id="module-posts-{{ $moduleKey }}" class="timeline-step-posts" {{ if $isCollapsed }} hidden{{ end }}>
          {{- range $modulePosts }}
          <article class="timeline-item child">
            <div class="timeline-order">#{{ printf "%02d" .Params.study_order }}</div>
            <div class="timeline-body">
              <h4 class="timeline-title"><a href="{{ .Permalink }}">{{ .Title }}</a></h4>
              <p class="timeline-desc">
                {{- with .Params.description -}}{{ . }}{{- else -}}{{ .Summary | plainify | truncate 140 }}{{- end -}}
              </p>
              <div class="timeline-meta">
                {{- if .Params.topic }}<span class="timeline-tag">{{ .Params.topic }}</span>{{- end }}
                <time datetime="{{ .Date.Format " 2006-01-02" }}">{{ .Date | time.Format "01/02" }}</time>
              </div>
            </div>
          </article>
          {{- end }}
        </div>
        {{- end }}
      </div>
      {{- end }}
    </div>
    {{- else }}
    <p class="empty-state">íƒ€ì„ë¼ì¸ì— í‘œì‹œí•  ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. front matterì— study_orderë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</p>
    {{- end }}
  </section>
</div>
<style>
  .learning-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
    padding-top: 5rem;
    min-height: 100vh;
  }

  .learning-hero {
    position: relative;
    background: linear-gradient(135deg, #a8c0ff 0%, #9795f0 100%);
    border-radius: 24px;
    padding: 4rem 2rem;
    margin-bottom: 3rem;
    overflow: hidden;
    box-shadow: 0 20px 40px rgba(168, 192, 255, 0.15);
  }

  .hero-content {
    position: relative;
    z-index: 2;
    text-align: center;
    color: white;
  }

  .hero-icon {
    font-size: 3.5rem;
    margin-bottom: 0.8rem;
    display: inline-block;
    animation: heroFloat 4s ease-in-out infinite;
  }

  .hero-title {
    font-size: 2.8rem;
    font-weight: 800;
    margin-bottom: 0.8rem;
    background: linear-gradient(135deg, #ffffff 0%, #f0f8ff 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .hero-description {
    font-size: 1.1rem;
    opacity: 0.95;
    max-width: 700px;
    margin: 0 auto;
    line-height: 1.6;
  }

  .hero-actions {
    display: flex;
    gap: 0.75rem;
    justify-content: center;
    margin: 1.6rem 0 0.5rem;
    flex-wrap: wrap;
  }

  .hero-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.85rem 1.4rem;
    border-radius: 14px;
    font-weight: 700;
    text-decoration: none;
    transition: all 0.2s ease;
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
    background: rgba(255, 255, 255, 0.12);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
  }

  .hero-btn.primary {
    background: white;
    color: #5b6cff;
    border-color: white;
  }

  .hero-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
  }

  .hero-badges {
    display: inline-flex;
    gap: 0.6rem;
    flex-wrap: wrap;
    justify-content: center;
    margin-top: 0.8rem;
  }

  .hero-badges span {
    background: rgba(255, 255, 255, 0.18);
    color: white;
    padding: 0.35rem 0.75rem;
    border-radius: 999px;
    font-size: 0.9rem;
    border: 1px solid rgba(255, 255, 255, 0.25);
  }

  .hero-background {
    position: absolute;
    inset: 0;
    z-index: 1;
  }

  .floating-element {
    position: absolute;
    width: 80px;
    height: 80px;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.08) 0%, transparent 70%);
    border-radius: 50%;
    animation: float 8s ease-in-out infinite;
  }

  .floating-element:nth-child(1) {
    top: 15%;
    left: 15%;
  }

  .floating-element:nth-child(2) {
    top: 55%;
    right: 20%;
    animation-delay: 3s;
  }

  .floating-element:nth-child(3) {
    bottom: 25%;
    left: 25%;
    animation-delay: 6s;
  }

  @keyframes float {

    0%,
    100% {
      transform: translateY(0)
    }

    50% {
      transform: translateY(-15px)
    }
  }

  @keyframes heroFloat {

    0%,
    100% {
      transform: translateY(0)
    }

    50% {
      transform: translateY(-8px)
    }
  }

  .section-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .section-header h2 {
    font-size: 1.8rem;
    font-weight: 800;
    margin: 0;
    background: linear-gradient(135deg, #a8c0ff, #9795f0);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .section-line {
    flex: 1;
    height: 2px;
    background: linear-gradient(90deg, #a8c0ff, transparent);
    border-radius: 1px;
  }

  .timeline-controls {
    display: inline-flex;
    gap: 0.5rem;
    flex: 0 0 auto;
  }

  .timeline-control {
    background: var(--entry);
    color: var(--primary);
    border: 1px solid var(--border);
    padding: 0.45rem 0.8rem;
    border-radius: 999px;
    font-weight: 800;
    font-size: 0.85rem;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    box-shadow: 0 4px 14px rgba(0, 0, 0, 0.04);
  }

  .timeline-control:hover {
    transform: translateY(-1px);
    box-shadow: 0 10px 22px rgba(168, 192, 255, 0.14);
    border-color: #a8c0ff;
  }

  .timeline-control:active {
    transform: translateY(0);
  }

  .timeline-intro {
    margin-bottom: 1.4rem;
  }

  .timeline-nav {
    display: flex;
    flex-wrap: wrap;
    gap: 0.6rem;
    margin: 0 0 1.6rem;
  }

  .timeline-nav-item {
    display: inline-flex;
    align-items: center;
    gap: 0.55rem;
    padding: 0.55rem 0.85rem;
    border-radius: 999px;
    background: var(--entry);
    border: 1px solid var(--border);
    text-decoration: none;
    color: var(--primary);
    transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    box-shadow: 0 4px 14px rgba(0, 0, 0, 0.04);
  }

  .timeline-nav-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 10px 22px rgba(168, 192, 255, 0.14);
    border-color: #a8c0ff;
  }

  .nav-step {
    font-size: 0.8rem;
    font-weight: 800;
    color: #6b7cff;
    background: var(--code-bg);
    border: 1px solid rgba(168, 192, 255, 0.25);
    padding: 0.2rem 0.55rem;
    border-radius: 999px;
    white-space: nowrap;
  }

  .nav-title {
    font-weight: 700;
    font-size: 0.95rem;
    max-width: 22ch;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .nav-count {
    font-size: 0.85rem;
    color: var(--secondary);
    font-variant-numeric: tabular-nums;
    white-space: nowrap;
  }

  .learning-timeline {
    margin: 2rem 0 2rem;
  }

  .timeline-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .timeline-list.grouped {
    gap: 1.4rem;
  }

  .timeline-step {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .timeline-step-posts {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .timeline-item {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 1rem;
    align-items: start;
    background: var(--entry);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 1rem 1.25rem;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.04);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .timeline-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 24px rgba(168, 192, 255, 0.14);
    border-color: #a8c0ff;
  }

  .timeline-order {
    min-width: 70px;
    height: 44px;
    padding: 0 10px;
    border-radius: 12px;
    background: linear-gradient(135deg, rgba(168, 192, 255, 0.18), rgba(151, 149, 240, 0.16));
    color: #5b6cff;
    font-weight: 800;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-variant-numeric: tabular-nums;
    box-shadow: inset 0 0 0 1px rgba(168, 192, 255, 0.3);
    font-size: 0.95rem;
    white-space: nowrap;
  }

  .timeline-body {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .timeline-title {
    margin: 0;
    font-size: 1.1rem;
  }

  .timeline-title a {
    color: var(--primary);
    text-decoration: none;
  }

  .timeline-title a:hover {
    color: #6b7cff;
  }

  .timeline-desc {
    color: var(--secondary);
    line-height: 1.6;
    margin: 0;
  }

  .module-head-row {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 0.9rem;
  }

  .module-head-meta {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    flex: 0 0 auto;
  }

  .module-count {
    background: var(--code-bg);
    padding: 0.25rem 0.65rem;
    border-radius: 999px;
    color: #6b7cff;
    border: 1px solid rgba(168, 192, 255, 0.25);
    font-weight: 700;
    font-size: 0.85rem;
    font-variant-numeric: tabular-nums;
    white-space: nowrap;
  }

  .module-toggle {
    background: var(--code-bg);
    color: #6b7cff;
    border: 1px solid rgba(168, 192, 255, 0.25);
    padding: 0.25rem 0.65rem;
    border-radius: 999px;
    font-weight: 800;
    font-size: 0.85rem;
    cursor: pointer;
    transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
    white-space: nowrap;
  }

  .module-toggle:hover {
    border-color: #a8c0ff;
    box-shadow: 0 8px 18px rgba(168, 192, 255, 0.14);
    transform: translateY(-1px);
  }

  .module-toggle:active {
    transform: translateY(0);
  }

  .module-toggle::after {
    content: "â–¾";
    display: inline-block;
    margin-left: 0.35rem;
    transition: transform 0.2s ease;
  }

  .module-toggle[aria-expanded="false"]::after {
    transform: rotate(-90deg);
  }

  .module-note {
    color: var(--secondary);
    margin: 0.1rem 0 0;
    font-size: 0.9rem;
  }

  .timeline-item.module-head {
    scroll-margin-top: 96px;
  }

  .timeline-step-posts[hidden] {
    display: none !important;
  }

  .timeline-meta {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    font-size: 0.9rem;
    color: var(--secondary);
  }

  .timeline-tag {
    background: var(--code-bg);
    padding: 0.25rem 0.65rem;
    border-radius: 10px;
    color: #6b7cff;
    border: 1px solid rgba(168, 192, 255, 0.25);
    font-weight: 600;
  }

  .module-head {
    border-left: 4px solid #a8c0ff;
  }

  .timeline-item.child {
    margin-left: 1.5rem;
  }

  .empty-state {
    padding: 2rem 0;
    color: var(--secondary);
  }

  .learning-rich-content {
    background: var(--entry);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.04);
  }

  .learning-rich-content h2,
  .learning-rich-content h3 {
    margin-top: 1.6rem;
    margin-bottom: 0.8rem;
  }

  .learning-rich-content p,
  .learning-rich-content ul,
  .learning-rich-content ol {
    color: var(--secondary);
    line-height: 1.7;
  }

  .learning-rich-content ul,
  .learning-rich-content ol {
    padding-left: 1.1rem;
    margin: 0.6rem 0 1rem;
  }

  .learning-rich-content code {
    background: var(--code-bg);
    padding: 0.1rem 0.35rem;
    border-radius: 6px;
  }

  .learning-rich-content pre {
    background: var(--code-bg);
    padding: 1rem;
    border-radius: 12px;
    overflow-x: auto;
  }

  @media (max-width: 768px) {
    .learning-container {
      padding: 1rem;
      padding-top: 4rem;
    }

    .learning-hero {
      padding: 3rem 1.5rem;
    }

    .hero-title {
      font-size: 2.1rem;
    }

    .hero-description {
      font-size: 1rem;
    }

    .hero-actions {
      flex-direction: column;
      align-items: center;
    }

    .hero-btn {
      width: 100%;
      justify-content: center;
    }

    .section-header {
      flex-wrap: wrap;
    }

    .timeline-controls {
      width: 100%;
      justify-content: flex-start;
    }

    .timeline-nav-item {
      width: 100%;
      justify-content: space-between;
    }

    .nav-title {
      max-width: 100%;
    }

    .timeline-item {
      grid-template-columns: 1fr;
    }

    .timeline-order {
      width: 44px;
      height: 44px;
    }
  }
</style>
<script>
  (() => {
    function setExpanded(step, expanded) {
      const toggle = step.querySelector(".module-toggle");
      if (!toggle) return;
      const postsId = toggle.getAttribute("aria-controls");
      const posts = postsId ? document.getElementById(postsId) : null;
      if (!posts) return;
      toggle.setAttribute("aria-expanded", expanded ? "true" : "false");
      toggle.textContent = expanded ? "ì ‘ê¸°" : "í¼ì¹˜ê¸°";
      posts.hidden = !expanded;
      step.classList.toggle("is-collapsed", !expanded);
    }

    function allSteps() {
      return Array.from(document.querySelectorAll(".timeline-step"));
    }

    document.addEventListener("click", (e) => {
      const btn = e.target.closest(".module-toggle");
      if (!btn) return;
      const step = btn.closest(".timeline-step");
      if (!step) return;
      const expanded = btn.getAttribute("aria-expanded") === "true";
      setExpanded(step, !expanded);
    });

    document.addEventListener("click", (e) => {
      const ctrl = e.target.closest(".timeline-control");
      if (!ctrl) return;
      const expand = ctrl.getAttribute("data-action") === "expand";
      allSteps().forEach((step) => setExpanded(step, expand));
    });

    function openFromHash() {
      const id = decodeURIComponent(location.hash.slice(1));
      if (!id) return;
      const el = document.getElementById(id);
      if (!el) return;
      const step = el.closest(".timeline-step");
      if (step) setExpanded(step, true);
    }

    window.addEventListener("hashchange", openFromHash);
    openFromHash();
  })();
</script>
{{ end }}