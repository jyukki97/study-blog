{{ if or .Params.mermaid .Site.Params.mermaid }}
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';

  const config = {
    startOnLoad: false,
    theme: document.body.getAttribute('class')?.includes('dark') ? 'dark' : 'default',
    securityLevel: 'loose',
  };
  mermaid.initialize(config);

  document.addEventListener("DOMContentLoaded", async function () {
    // Transform standard code blocks to mermaid divs
    const codeBlocks = document.querySelectorAll('code.language-mermaid');
    for (const code of codeBlocks) {
      const pre = code.parentElement;
      if (pre.tagName === 'PRE') {
        const div = document.createElement('div');
        div.className = 'mermaid';
        div.textContent = code.textContent;

        // Hide original pre
        pre.style.display = 'none';
        pre.parentNode.insertBefore(div, pre);
        // Remove original pre after insert
        pre.remove();
      }
    }

    // Run mermaid on the new elements
    await mermaid.run({
      querySelector: '.mermaid'
    });
  });
</script>
{{ end }}