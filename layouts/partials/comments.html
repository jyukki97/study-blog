{{- if .Site.Params.comments -}}

<!-- ëŒ“ê¸€ ì‹œìŠ¤í…œ ì„ íƒ (Giscus ë˜ëŠ” Utterances) -->
{{- if and (.Site.Params.giscus.repo) (.Site.Params.giscus.repoID) (not .Params.disableComments) -}}
<!-- Giscus ëŒ“ê¸€ ì‹œìŠ¤í…œ -->
<div id="comments" class="comments-container giscus-enabled">
    <div class="comments-header">
        <h3 class="comments-title">
            <i class="comments-icon" aria-hidden="true">ğŸ’¬</i>
            ëŒ“ê¸€
        </h3>
        <div class="comments-info">
            <small>GitHub ê³„ì •ìœ¼ë¡œ ëŒ“ê¸€ì„ ë‚¨ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
        </div>
    </div>
    
    <div class="giscus-container">
        <script src="https://giscus.app/client.js"
                data-repo="{{ .Site.Params.giscus.repo }}"
                data-repo-id="{{ .Site.Params.giscus.repoID }}"
                data-category="{{ .Site.Params.giscus.category | default "General" }}"
                data-category-id="{{ .Site.Params.giscus.categoryID }}"
                data-mapping="{{ .Site.Params.giscus.mapping | default "pathname" }}"
                data-strict="{{ .Site.Params.giscus.strict | default "0" }}"
                data-reactions-enabled="{{ .Site.Params.giscus.reactionsEnabled | default "1" }}"
                data-emit-metadata="{{ .Site.Params.giscus.emitMetadata | default "0" }}"
                data-input-position="{{ .Site.Params.giscus.inputPosition | default "bottom" }}"
                data-theme="{{ .Site.Params.giscus.theme | default "preferred_color_scheme" }}"
                data-lang="{{ .Site.Params.giscus.lang | default "ko" }}"
                data-loading="lazy"
                crossorigin="anonymous"
                async>
        </script>
    </div>
    
    <!-- ëŒ“ê¸€ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
    <div id="comments-preview" class="comments-preview" style="display: none;">
        <div class="preview-header">
            <span class="preview-title">ë¯¸ë¦¬ë³´ê¸°</span>
            <button id="close-preview" class="close-preview-btn" aria-label="ë¯¸ë¦¬ë³´ê¸° ë‹«ê¸°">Ã—</button>
        </div>
        <div class="preview-content"></div>
    </div>
    
    <!-- ëŒ“ê¸€ ì•Œë¦¼ -->
    <div id="comment-notification" class="comment-notification" style="display: none;">
        <div class="notification-content">
            <span class="notification-icon">ğŸ””</span>
            <span class="notification-text"></span>
            <button class="notification-close" aria-label="ì•Œë¦¼ ë‹«ê¸°">Ã—</button>
        </div>
    </div>
</div>

{{- else if and (.Site.Params.utterances.repo) (not .Params.disableComments) -}}
<!-- Utterances ëŒ“ê¸€ ì‹œìŠ¤í…œ (ëŒ€ì•ˆ) -->
<div id="comments" class="comments-container utterances-enabled">
    <div class="comments-header">
        <h3 class="comments-title">
            <i class="comments-icon" aria-hidden="true">ğŸ’¬</i>
            ëŒ“ê¸€
        </h3>
        <div class="comments-info">
            <small>GitHub ê³„ì •ìœ¼ë¡œ ëŒ“ê¸€ì„ ë‚¨ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
        </div>
    </div>
    
    <div class="utterances-container">
        <script src="https://utteranc.es/client.js"
                repo="{{ .Site.Params.utterances.repo }}"
                issue-term="{{ .Site.Params.utterances.issueTerm | default "pathname" }}"
                label="{{ .Site.Params.utterances.label | default "comment" }}"
                theme="{{ .Site.Params.utterances.theme | default "github-light" }}"
                crossorigin="anonymous"
                async>
        </script>
    </div>
    
    <!-- ëŒ“ê¸€ ì•Œë¦¼ -->
    <div id="comment-notification" class="comment-notification" style="display: none;">
        <div class="notification-content">
            <span class="notification-icon">ğŸ””</span>
            <span class="notification-text"></span>
            <button class="notification-close" aria-label="ì•Œë¦¼ ë‹«ê¸°">Ã—</button>
        </div>
    </div>
</div>

{{- else if not .Params.disableComments -}}
<!-- ëŒ“ê¸€ ì‹œìŠ¤í…œ ì„¤ì • ì•ˆë‚´ -->
<div id="comments" class="comments-container setup-required">
    <div class="comments-header">
        <h3 class="comments-title">
            <i class="comments-icon" aria-hidden="true">âš™ï¸</i>
            ëŒ“ê¸€ ì‹œìŠ¤í…œ ì„¤ì • í•„ìš”
        </h3>
    </div>
    
    <div class="setup-guide">
        <div class="setup-info">
            <h4>ëŒ“ê¸€ ì‹œìŠ¤í…œì„ í™œì„±í™”í•˜ë ¤ë©´:</h4>
            
            <div class="setup-options">
                <div class="setup-option">
                    <h5>ğŸš€ Giscus (ì¶”ì²œ)</h5>
                    <ol>
                        <li><a href="https://github.com/apps/giscus" target="_blank" rel="noopener">Giscus ì•±</a>ì„ GitHub ì €ì¥ì†Œì— ì„¤ì¹˜</li>
                        <li><a href="https://giscus.app/ko" target="_blank" rel="noopener">Giscus ì„¤ì • í˜ì´ì§€</a>ì—ì„œ ì €ì¥ì†Œ ì •ë³´ ì…ë ¥</li>
                        <li>ìƒì„±ëœ ì„¤ì •ì„ <code>hugo.toml</code>ì— ì¶”ê°€</li>
                    </ol>
                    <details class="setup-details">
                        <summary>ì„¤ì • ì˜ˆì‹œ ë³´ê¸°</summary>
                        <pre><code>[params.giscus]
repo = "ì‚¬ìš©ìëª…/ì €ì¥ì†Œëª…"
repoID = "ì—¬ê¸°ì—_REPO_ID_ì…ë ¥"
category = "General"
categoryID = "ì—¬ê¸°ì—_CATEGORY_ID_ì…ë ¥"
mapping = "pathname"
theme = "preferred_color_scheme"
lang = "ko"</code></pre>
                    </details>
                </div>
                
                <div class="setup-option">
                    <h5>ğŸ“ Utterances (ê°„ë‹¨í•œ ëŒ€ì•ˆ)</h5>
                    <ol>
                        <li><a href="https://github.com/apps/utterances" target="_blank" rel="noopener">Utterances ì•±</a>ì„ GitHub ì €ì¥ì†Œì— ì„¤ì¹˜</li>
                        <li><code>hugo.toml</code>ì— ì„¤ì • ì¶”ê°€</li>
                    </ol>
                    <details class="setup-details">
                        <summary>ì„¤ì • ì˜ˆì‹œ ë³´ê¸°</summary>
                        <pre><code>[params.utterances]
repo = "ì‚¬ìš©ìëª…/ì €ì¥ì†Œëª…"
issueTerm = "pathname"
label = "comment"
theme = "github-light"</code></pre>
                    </details>
                </div>
            </div>
            
            <div class="setup-help">
                <p><strong>ë„ì›€ì´ í•„ìš”í•˜ì‹œë‚˜ìš”?</strong></p>
                <ul>
                    <li><a href="https://giscus.app/ko" target="_blank" rel="noopener">Giscus ê³µì‹ ê°€ì´ë“œ</a></li>
                    <li><a href="https://utteranc.es/" target="_blank" rel="noopener">Utterances ê³µì‹ ê°€ì´ë“œ</a></li>
                    <li><a href="https://docs.github.com/ko/discussions" target="_blank" rel="noopener">GitHub Discussions ê°€ì´ë“œ</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>
{{- end -}}

<!-- ëŒ“ê¸€ ê´€ë ¨ JavaScript -->
<script>
// ëŒ“ê¸€ ì‹œìŠ¤í…œ ê³µí†µ ê¸°ëŠ¥
class CommentSystem {
    constructor() {
        this.init();
    }

    init() {
        this.setupNotifications();
        this.setupThemeSync();
        this.setupKeyboardShortcuts();
        this.trackCommentInteractions();
    }

    // ì•Œë¦¼ ì‹œìŠ¤í…œ
    setupNotifications() {
        // ì•Œë¦¼ ë‹«ê¸° ë²„íŠ¼
        document.addEventListener('click', (e) => {
            if (e.target.matches('.notification-close')) {
                e.target.closest('.comment-notification').style.display = 'none';
            }
        });
    }

    // í…Œë§ˆ ë™ê¸°í™” (Giscus/Utterances)
    setupThemeSync() {
        // Giscus í…Œë§ˆ ë™ê¸°í™”
        const syncGiscusTheme = () => {
            const theme = document.documentElement.getAttribute('data-theme') || 'auto';
            const giscusFrame = document.querySelector('iframe.giscus-frame');
            if (giscusFrame) {
                giscusFrame.contentWindow.postMessage({
                    giscus: {
                        setConfig: {
                            theme: theme === 'dark' ? 'dark' : theme === 'light' ? 'light' : 'preferred_color_scheme'
                        }
                    }
                }, 'https://giscus.app');
            }
        };

        // Utterances í…Œë§ˆ ë™ê¸°í™”
        const syncUtterancesTheme = () => {
            const theme = document.documentElement.getAttribute('data-theme') || 'auto';
            const utterancesFrame = document.querySelector('.utterances-frame');
            if (utterancesFrame) {
                const utterancesTheme = theme === 'dark' ? 'github-dark' : 'github-light';
                utterancesFrame.contentWindow.postMessage({
                    type: 'set-theme',
                    theme: utterancesTheme
                }, 'https://utteranc.es');
            }
        };

        // í…Œë§ˆ ë³€ê²½ ê°ì§€
        const themeObserver = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
                    setTimeout(() => {
                        syncGiscusTheme();
                        syncUtterancesTheme();
                    }, 100);
                }
            });
        });

        themeObserver.observe(document.documentElement, {
            attributes: true,
            attributeFilter: ['data-theme']
        });

        // ëŒ“ê¸€ ì‹œìŠ¤í…œ ë¡œë“œ ì™„ë£Œ í›„ í…Œë§ˆ ë™ê¸°í™”
        window.addEventListener('message', (event) => {
            if (event.origin === 'https://giscus.app' && event.data.giscus?.discussion) {
                syncGiscusTheme();
                this.showNotification('ëŒ“ê¸€ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
            
            if (event.origin === 'https://utteranc.es' && event.data.type === 'resize') {
                syncUtterancesTheme();
                this.showNotification('ëŒ“ê¸€ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        });
    }

    // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
    setupKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            // Ctrl+Shift+C: ëŒ“ê¸€ë¡œ ì´ë™
            if (e.ctrlKey && e.shiftKey && e.key === 'C') {
                e.preventDefault();
                this.scrollToComments();
            }
        });
    }

    scrollToComments() {
        const commentsSection = document.getElementById('comments');
        if (commentsSection) {
            commentsSection.scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
            this.showNotification('ëŒ“ê¸€ ì„¹ì…˜ìœ¼ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.', 'info', 2000);
        }
    }

    // ëŒ“ê¸€ ìƒí˜¸ì‘ìš© ì¶”ì 
    trackCommentInteractions() {
        const commentsContainer = document.getElementById('comments');
        if (commentsContainer) {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        // Google Analytics ì¶”ì 
                        if (typeof trackCommentInteraction !== 'undefined') {
                            trackCommentInteraction('view');
                        }
                    }
                });
            });
            
            observer.observe(commentsContainer);
        }
    }

    // ì•Œë¦¼ í‘œì‹œ
    showNotification(message, type = 'info', duration = 3000) {
        const notification = document.getElementById('comment-notification');
        if (!notification) return;

        const notificationText = notification.querySelector('.notification-text');
        const notificationIcon = notification.querySelector('.notification-icon');
        
        // íƒ€ì…ë³„ ì•„ì´ì½˜ ì„¤ì •
        const icons = {
            info: 'ğŸ“¢',
            success: 'âœ…',
            warning: 'âš ï¸',
            error: 'âŒ'
        };
        
        if (notificationIcon) notificationIcon.textContent = icons[type] || icons.info;
        if (notificationText) notificationText.textContent = message;
        
        notification.style.display = 'block';
        
        // ìë™ ìˆ¨ê¹€
        setTimeout(() => {
            notification.style.display = 'none';
        }, duration);
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ëŒ“ê¸€ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', () => {
    if (document.getElementById('comments')) {
        window.commentSystem = new CommentSystem();
    }
});

// URL í•´ì‹œê°€ #commentsì¸ ê²½ìš° ìŠ¤í¬ë¡¤
if (window.location.hash === '#comments') {
    setTimeout(() => {
        document.getElementById('comments')?.scrollIntoView({ behavior: 'smooth' });
    }, 1000);
}
</script>
{{- end -}}