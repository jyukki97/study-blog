---
title: "Rate Limiter: íŠ¸ë˜í”½ í™ìˆ˜ì—ì„œ ì‚´ì•„ë‚¨ê¸°"
date: 2025-12-16
draft: false
topic: "System Design"
tags: ["Rate Limiting", "Token Bucket", "Sliding Window", "Redis"]
categories: ["Backend Deep Dive"]
description: "DDoS ë°©ì–´ë¶€í„° ìœ ë£Œ API ì‚¬ìš©ëŸ‰ ì œí•œê¹Œì§€. Token Bucket ì•Œê³ ë¦¬ì¦˜ê³¼ Redis ë¶„ì‚° ì²˜ë¦¬"
module: "architecture"
study_order: 458
---

## ğŸš§ 1. ì™œ ë§‰ì•„ì•¼ í•˜ë‚˜ìš”?

"ë¬´í•œëŒ€ë¡œ ë°›ìœ¼ë©´ ì¢‹ì€ ê±° ì•„ë‹Œê°€ìš”?"
ì•„ë‹™ë‹ˆë‹¤. ëª¨ë“  ì‹œìŠ¤í…œì€ ìš©ëŸ‰ì˜ í•œê³„ê°€ ìˆìŠµë‹ˆë‹¤.

1. **Protection**: DDoS ê³µê²©ì´ë‚˜ ë²„ê·¸ë¡œ ì¸í•œ íŠ¸ë˜í”½ í­ì£¼ ë°©ì§€.
2. **Fairness**: íŠ¹ì • ì‚¬ìš©ìê°€ ë¦¬ì†ŒìŠ¤ë¥¼ ë…ì í•˜ì§€ ëª»í•˜ê²Œ í•¨ (Neighbor Problem).
3. **Business**: ìœ ë£Œ í”Œëœì— ë”°ë¥¸ ë“±ê¸‰ ë‚˜ëˆ„ê¸° (Free: 100req/min, Pro: 1000req/min).

---

## ğŸª£ 2. Token Bucket ì•Œê³ ë¦¬ì¦˜

ê°€ì¥ ë„ë¦¬ ì“°ì´ëŠ” ì•Œê³ ë¦¬ì¦˜ì…ë‹ˆë‹¤. AWS, Google Guava ë“±ì—ì„œ ì±„íƒí–ˆìŠµë‹ˆë‹¤.

```mermaid
graph TD
    Bucket[ë²„í‚· (Token í†µ)]
    Refill[ì¶©ì „ ê¸°ê³„] -->|ì´ˆë‹¹ Nê°œ| Bucket
    User[ì‚¬ìš©ì ìš”ì²­] -->|1. í† í° ìˆë‹ˆ?| Bucket
    
    Bucket -->|Yes (í† í° -1)| Success[ìš”ì²­ ì²˜ë¦¬]
    Bucket -->|No (0ê°œ)| Fail[429 Too Many Requests]
    
    style Bucket fill:#f9f,stroke:#333
```

- **ë²„í‚· í¬ê¸° (Capacity)**: ìµœëŒ€ ëª¨ì„ ìˆ˜ ìˆëŠ” í† í° ìˆ˜. (ì´ë§Œí¼ì˜ **ìˆœê°„ íŠ¸ë˜í”½(Burst)** ì„ í—ˆìš©í•¨)
- **ì¶©ì „ ì†ë„ (Refill Rate)**: ì´ˆë‹¹ ëª‡ ê°œì”© ìƒê¸°ë‚˜. (ì§€ì† ê°€ëŠ¥í•œ í‰ê·  ì²˜ë¦¬ëŸ‰)

> **ë¹„ìœ **: ì§€í•˜ì²  ê°œì°°êµ¬ì— í‘œë¥¼ ë¯¸ë¦¬ 10ì¥ ì‚¬ë‘” ì‚¬ëŒì€ ì—°ì†ìœ¼ë¡œ 10ëª… ë¹ ë¥´ê²Œ ì§€ë‚˜ê°ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ í‘œê°€ ë–¨ì–´ì§€ë©´ ë§¤í‘œì†Œì—ì„œ í•œ ì¥ì”© ì‚¬ì•¼ í•˜ë‹ˆ ì†ë„ê°€ ëŠë ¤ì§‘ë‹ˆë‹¤.

---

## ğŸªŸ 3. Sliding Window (ìŠ¬ë¼ì´ë”© ìœˆë„ìš°)

"1ë¶„ì— 100ê°œ ì œí•œ"ì¸ë°, **59ì´ˆì— 100ê°œ, 01ì´ˆì— 100ê°œ**ê°€ ë“¤ì–´ì˜¤ë©´?
ê³ ì • ìœˆë„ìš°(Fixed Window) ë°©ì‹ì€ ê²½ê³„ê°’ ë¶€ê·¼ì—ì„œ 2ë°°ì˜ íŠ¸ë˜í”½ì„ í—ˆìš©í•˜ëŠ” ë²„ê·¸ê°€ ìˆìŠµë‹ˆë‹¤.

ì´ë¥¼ ë§‰ê¸° ìœ„í•´ **Sliding Window**ëŠ” ì‹œê°„ì„ ê²¹ì³ì„œ ê³„ì‚°í•©ë‹ˆë‹¤.
(Redisì˜ `ZSET`ì„ ì´ìš©í•´ íƒ€ì„ìŠ¤íƒ¬í”„ ë¡œê·¸ë¥¼ ì €ì¥í•˜ê³  `count`í•˜ëŠ” ë°©ì‹ì´ ì •í™•í•˜ì§€ë§Œ, ë©”ëª¨ë¦¬ë¥¼ ë§ì´ ì”ë‹ˆë‹¤.)

---

## âš¡ 4. ë¶„ì‚° í™˜ê²½ êµ¬í˜„ì˜ í•µì‹¬: Redis + Lua

ì„œë²„ê°€ ì—¬ëŸ¬ ëŒ€ì¼ ë•Œ, ë¡œì»¬ ë©”ëª¨ë¦¬(HashMap)ì— ì¹´ìš´íŠ¸ë¥¼ ì €ì¥í•˜ë©´ êµ¬ë©ì´ ìˆ­ìˆ­ ëš«ë¦½ë‹ˆë‹¤.
**ì¤‘ì•™ ì €ì¥ì†Œ(Redis)** ê°€ í•„ìš”í•©ë‹ˆë‹¤.

í•˜ì§€ë§Œ `GET` -> `ê³„ì‚°` -> `SET` ì‚¬ì´ì— Race Conditionì´ ë°œìƒí•©ë‹ˆë‹¤.
ê·¸ë˜ì„œ **Lua Script**ë¡œ ì›ìì„±(Atomicity)ì„ ë³´ì¥í•´ì•¼ í•©ë‹ˆë‹¤.

```lua
-- redis_rate_limit.lua
local key = KEYS[1]
local limit = tonumber(ARGV[1])

local current = tonumber(redis.call('get', key) or "0")

if current + 1 > limit then
    return 0 -- ì°¨ë‹¨
else
    redis.call('incr', key)
    redis.call('expire', key, 60) -- 1ë¶„ TTL
    return 1 -- í†µê³¼
end
```

## ìš”ì•½

1. **ì•Œê³ ë¦¬ì¦˜**: **Token Bucket**ì´ í‘œì¤€. ë²„ìŠ¤íŠ¸ í˜€ìš©ì´ ì‹«ìœ¼ë©´ Leaky Bucket.
2. **ìœ„ì¹˜**: API Gatewayë‚˜ ì•ë‹¨ì—ì„œ ë§‰ì„ìˆ˜ë¡ ì¢‹ë‹¤. (App ì„œë²„ ë¦¬ì†ŒìŠ¤ ë³´í˜¸)
3. **êµ¬í˜„**: ë¶„ì‚° í™˜ê²½ì—ì„œëŠ” Redis Lua Scriptë¡œ ì›ìì„±ì„ ì±™ê²¨ë¼.
4. **ì‘ë‹µ**: ê·¸ëƒ¥ ê±°ì ˆí•˜ì§€ ë§ê³  `Retry-After` í—¤ë”ë¥¼ ì¤˜ë¼. (í´ë¼ì´ì–¸íŠ¸ ì˜ˆì ˆ)
