---
title: "ë°ì´í„° ìƒ¤ë”©ê³¼ Consistent Hashing"
date: 2025-12-28
draft: false
topic: "Database"
tags: ["Sharding", "Consistent Hashing", "Database Scaling", "Snowflake"]
categories: ["Backend Deep Dive"]
description: "DB ë°ì´í„°ë¥¼ ì—¬ëŸ¬ ì„œë²„ì— ë‚˜ëˆ„ëŠ” ìƒ¤ë”© ì „ëµê³¼, ì„œë²„ ì¦ì„¤ ì‹œ ë°ì´í„° ì´ë™ì„ ìµœì†Œí™”í•˜ëŠ” Consistent Hashing ì•Œê³ ë¦¬ì¦˜ ì„¤ëª…."
module: "distributed-system"
study_order: 405
---

## ğŸ• 1. ìƒ¤ë”©(Sharding): ë°ì´í„°ë¥¼ ì¡°ê°ë‚´ì

ì„œë¹„ìŠ¤ê°€ ëŒ€ë°•ì´ ë‚˜ì„œ ì‚¬ìš©ìê°€ 1ì–µ ëª…ì´ ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¨ì¼ DBë¡œëŠ” ê°ë‹¹ì´ ì•ˆ ë©ë‹ˆë‹¤.
ì´ì œ ë°ì´í„°ë¥¼ ì—¬ëŸ¬ ì„œë²„ì— ë‚˜ëˆ  ë‹´ì•„ì•¼ í•˜ëŠ”ë°, ì´ë¥¼ **ìƒ¤ë”©(Sharding)**ì´ë¼ í•©ë‹ˆë‹¤.

ë¬¸ì œëŠ” **"ì–´ë–¤ ê¸°ì¤€ìœ¼ë¡œ ë‚˜ëˆŒ ê²ƒì¸ê°€?"**ì…ë‹ˆë‹¤.

### ì „ëµ 1: Range Sharding (ë²”ìœ„)
- `ì‹ë³„ì 1 ~ 100ë§Œ` -> **DB 1**
- `ì‹ë³„ì 100ë§Œ ~ 200ë§Œ` -> **DB 2**
- **ë¬¸ì œì **: ìµœê·¼ ê°€ì…í•œ ìœ ì €ë§Œ í™œë™í•œë‹¤ë©´? **DB 2ë§Œ ë¶ˆíƒ€ì˜¤ë¥´ê³ (Hotspot)** DB 1ì€ ë†‰ë‹ˆë‹¤.

### ì „ëµ 2: Modular Sharding (í•´ì‹œ)
- `ID % ì„œë²„ìˆ˜`ë¡œ ë°°ì •í•©ë‹ˆë‹¤. ë°ì´í„°ê°€ ì•„ì£¼ ê³ ë¥´ê²Œ í¼ì§‘ë‹ˆë‹¤.
- **ì¹˜ëª…ì  ë¬¸ì œ**: ì„œë²„ë¥¼ 3ëŒ€ì—ì„œ 4ëŒ€ë¡œ ëŠ˜ë¦¬ë©´?

```
User ID = 3
Before (Mod 3): 3 % 3 = 0ë²ˆ ì„œë²„
After  (Mod 4): 3 % 4 = 3ë²ˆ ì„œë²„
```

> âš ï¸ **ì¬ì•™(Rebalancing)**: ì„œë²„ ëŒ€ìˆ˜ê°€ ë°”ë€Œë©´ **ê±°ì˜ ëª¨ë“  ë°ì´í„°ê°€ ì´ë™**í•´ì•¼ í•©ë‹ˆë‹¤. ì„œë¹„ìŠ¤ ì¤‘ë‹¨ ì—†ì´ëŠ” ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.

### Modular vs Consistent Hashing

| íŠ¹ì§• | Modular Hashing | Consistent Hashing |
| :--- | :--- | :--- |
| **ê·œì¹™** | `Key % N` | `Hash(Key)`ì˜ ë§ ìœ„ ìœ„ì¹˜ |
| **ì„œë²„ ì¶”ê°€ ì‹œ** | **ì „ì²´ ë°ì´í„°**ì˜ ì•½ `100%` ì´ë™ | **ì¼ë¶€ ë°ì´í„°** (`1/N`)ë§Œ ì´ë™ |
| **ìœ ì—°ì„±** | ë§¤ìš° ë‚®ìŒ (ì„œë²„ ìˆ˜ ê³ ì • ê¶Œì¥) | ë§¤ìš° ë†’ìŒ (Elastic Scaling) |
| **ë³µì¡ë„** | ë‚®ìŒ | ì¤‘ê°„ (ë§ ê´€ë¦¬, ê°€ìƒ ë…¸ë“œ) |

---

## ğŸ© 2. Consistent Hashing (ì¼ê´€ëœ í•´ì‹±)

ì´ ì¬ì•™ì„ ë§‰ê¸° ìœ„í•´ **"ì„œë²„ê°€ ì¶”ê°€/ì‚­ì œë˜ì–´ë„ ë°ì´í„° ì´ë™ì„ ìµœì†Œí™”"**í•˜ëŠ” ì•Œê³ ë¦¬ì¦˜ì´ ë‚˜ì™”ìŠµë‹ˆë‹¤.
í•µì‹¬ì€ **ì›í˜• ë§(Ring)**ì…ë‹ˆë‹¤.

### ë™ì‘ ì›ë¦¬

```mermaid
graph TD
    subgraph Ring ["Hash Ring (0 ~ 2^32)"]
        N1((Node A: 100))
        N2((Node B: 300))
        N3((Node C: 600))
        
        N1 --- N2
        N2 --- N3
        N3 --- N1
    end
    
    Data1[Key 1: Hash 150] -->|Clockwise ->| N2
    Data2[Key 2: Hash 400] -->|Clockwise ->| N3
    Data3[Key 3: Hash 800] -->|Clockwise ->| N1
    
    style N1 fill:#ffccbc,stroke:#d84315
    style N2 fill:#ffe0b2,stroke:#ef6c00
    style N3 fill:#fff9c4,stroke:#fbc02d
```

1. ì»¤ë‹¤ë€ ì›(í•´ì‹œ ë§)ì„ ìƒìƒí•˜ì„¸ìš”. (0 ~ 2^32)
2. **ì„œë²„(Node)**ë¥¼ í•´ì‹œê°’ì— ë”°ë¼ ë§ ìœ„ì— ë°°ì¹˜í•©ë‹ˆë‹¤.
3. **ë°ì´í„°(Key)**ë„ í•´ì‹œê°’ì— ë”°ë¼ ë§ ìœ„ì— ë°°ì¹˜í•©ë‹ˆë‹¤.
4. ë°ì´í„°ëŠ” **ì‹œê³„ ë°©í–¥ìœ¼ë¡œ ëŒë©´ì„œ ë§Œë‚˜ëŠ” ì²« ë²ˆì§¸ ì„œë²„**ì— ì €ì¥ë©ë‹ˆë‹¤.

### ì„œë²„ê°€ ì¶”ê°€ëœë‹¤ë©´?

ì„œë²„ Cì™€ A ì‚¬ì´ì— **ì„œë²„ D**ë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.

- **ê¸°ì¡´ Modular**: ì „ì²´ ë°ì´í„°ì˜ 100%ê°€ ë’¤ì„ì„.
- **Consistent Hashing**: **Cì™€ D ì‚¬ì´ì˜ ë°ì´í„°ë§Œ** Aì—ì„œ Dë¡œ ì´ë™. ë‚˜ë¨¸ì§€(A->B, B->C)ëŠ” ê·¸ëŒ€ë¡œ!

> **ê²°ê³¼**: ë°ì´í„° ì´ë™ëŸ‰ì´ `1/N`ë¡œ íšê¸°ì ìœ¼ë¡œ ì¤„ì–´ë“­ë‹ˆë‹¤.

### 2.2 ê°€ìƒ ë…¸ë“œ (Virtual Nodes)
"ìš´ ë‚˜ì˜ê²Œ Node A, B, Cê°€ í•œìª½ì— ì ë ¤ ìˆìœ¼ë©´ ì–´ë–¡í•˜ì£ ?" (Data Skew)
-> **ê°€ì§œ ë…¸ë“œ**ë¥¼ ìˆ˜ë°± ê°œ ë§Œë“¤ì–´ì„œ ë§ ì „ì²´ì— ë¿Œë¦½ë‹ˆë‹¤.

```mermaid
graph TD
    subgraph VirtualRing ["Virtual Nodes Spread"]
        A1((A-1)) --- B1((B-1))
        B1 --- C1((C-1))
        C1 --- A2((A-2))
        A2 --- B2((B-2))
        B2 --- C2((C-2))
        C2 --- A1
    end
    
    Note[Data is evenly distributed due to high variety of V-Nodes]
```

---

## ğŸ†” 3. ë¶„ì‚° ID ìƒì„±ê¸° (Snowflake)

ìƒ¤ë”©ì„ í•˜ë©´ DBì˜ `AUTO_INCREMENT`ë¥¼ ëª» ì”ë‹ˆë‹¤. (1ë²ˆ DBì™€ 2ë²ˆ DBì—ì„œ ê°™ì€ ID 100ë²ˆì´ ìƒê¸°ë©´ ì¶©ëŒ)
ì „ì—­ì ìœ¼ë¡œ ìœ ì¼í•œ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.

### Twitter Snowflake êµ¬ì¡° (64bit)

```mermaid
packet-beta
0-15: "Sequence (12bit)\n(ë™ì¼ ë°€ë¦¬ì´ˆ ë‚´ ìˆœì„œ)"
16-25: "Machine ID (10bit)\n(ì„œë²„ ì‹ë³„)"
26-63: "Timestamp (41bit)\n(ì‹œê°„ìˆœ ì •ë ¬)"
```

| í•„ë“œ | ë¹„íŠ¸ ìˆ˜ | ì„¤ëª… |
| :--- | :--- | :--- |
| **Sign Bit** | 1 bit | ì–‘ìˆ˜ ë³´ì¥ (í•­ìƒ 0) |
| **Timestamp** | 41 bit | ë°€ë¦¬ì´ˆ ë‹¨ìœ„ ì‹œê°„ (ì•½ 69ë…„ ì‚¬ìš© ê°€ëŠ¥) |
| **Machine ID** | 10 bit | 1024ê°œì˜ ë…¸ë“œ ì‹ë³„ ê°€ëŠ¥ |
| **Sequence** | 12 bit | ë°€ë¦¬ì´ˆë‹¹ 4096ê°œ ID ìƒì„± ê°€ëŠ¥ |

1. **Timestamp**: ì‹œê°„ìˆœ ì •ë ¬ì„ ë³´ì¥í•©ë‹ˆë‹¤. (Index ì„±ëŠ¥ì— ì¤‘ìš”)
2. **Machine ID**: ì–´ëŠ ì„œë²„ì—ì„œ ìƒì„±í–ˆëŠ”ì§€ êµ¬ë¶„í•©ë‹ˆë‹¤.
3. **Sequence**: ê°™ì€ ë°€ë¦¬ì´ˆì— ìƒì„±ëœ IDë¥¼ êµ¬ë¶„í•©ë‹ˆë‹¤.

## ìš”ì•½

- **Range Sharding**: ì‰½ì§€ë§Œ í•«ìŠ¤íŒŸ ìœ„í—˜.
- **Modular Sharding**: ê· ë“±í•˜ì§€ë§Œ í™•ì¥ ì‹œ ëŒ€ì´ë™(Rebalancing) ë°œìƒ.
- **Consistent Hashing**: í™•ì¥ì´ ìœ ì—°í•¨. (í˜„ëŒ€ ë¶„ì‚° ì‹œìŠ¤í…œ í‘œì¤€)
- **Snowflake**: íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ë°˜ì˜ ìœ ë‹ˆí¬ ID ìƒì„± ì „ëµ.
