name: Build and Deploy Blog

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # ë§¤ì¼ ìì •ì— ìë™ ë¹Œë“œ (ìºì‹œ ê°±ì‹ )
    - cron: '0 0 * * *'

env:
  HUGO_VERSION: '0.124.0'
  NODE_VERSION: '18'

jobs:
  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  quality-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm install -g markdownlint-cli
        npm install -g htmlhint
        npm install -g eslint

    - name: Lint Markdown files
      run: |
        markdownlint content/**/*.md || true

    - name: Lint JavaScript files
      run: |
        eslint static/js/*.js || true

    - name: Check Hugo configuration
      run: |
        wget -O hugo.deb https://github.com/gohugoio/hugo/releases/download/v${{ env.HUGO_VERSION }}/hugo_extended_${{ env.HUGO_VERSION }}_linux-amd64.deb
        sudo dpkg -i hugo.deb
        hugo config

  # ì‚¬ì´íŠ¸ ë¹Œë“œ
  build:
    needs: quality-check
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Setup Hugo
      uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: ${{ env.HUGO_VERSION }}
        extended: true

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install Node dependencies
      run: |
        if [ -f package.json ]; then
          npm ci
        fi

    - name: Build site
      run: |
        hugo --minify --environment production

    - name: Optimize images
      run: |
        # ì´ë¯¸ì§€ ìµœì í™” ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        if [ -f scripts/optimize-images.sh ]; then
          chmod +x scripts/optimize-images.sh
          ./scripts/optimize-images.sh
        fi

    - name: Generate sitemap
      run: |
        # ì¶”ê°€ ì‚¬ì´íŠ¸ë§µ ìƒì„±
        echo "Generating additional sitemaps..."
        # í•„ìš”ì‹œ ì»¤ìŠ¤í…€ ì‚¬ì´íŠ¸ë§µ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: blog-build
        path: public/
        retention-days: 7

  # ë³´ì•ˆ ìŠ¤ìº”
  security-scan:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: blog-build
        path: public/

    - name: Run security scan
      run: |
        # HTML ë³´ì•ˆ ê²€ì‚¬
        grep -r "javascript:" public/ || true
        grep -r "onclick=" public/ || true
        
        # CSP í—¤ë” ê²€ì‚¬
        echo "Checking Content Security Policy..."

    - name: Check for secrets
      run: |
        # ë¯¼ê°í•œ ì •ë³´ ë…¸ì¶œ ê²€ì‚¬
        grep -r "password\|secret\|token\|key" public/ --exclude-dir=js || true

  # ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
  performance-test:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: blog-build
        path: public/

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Install Lighthouse CI
      run: |
        npm install -g @lhci/cli

    - name: Start local server
      run: |
        cd public
        python3 -m http.server 8080 &
        sleep 5

    - name: Run Lighthouse CI
      run: |
        lhci autorun --config=.lighthouserc.json || true

    - name: Upload Lighthouse results
      uses: actions/upload-artifact@v4
      with:
        name: lighthouse-results
        path: .lighthouseci/
        retention-days: 30

  # ìŠ¤í…Œì´ì§• ë°°í¬
  deploy-staging:
    needs: [build, security-scan, performance-test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    environment:
      name: staging
      url: https://staging.jyukki.dev
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: blog-build
        path: public/

    - name: Deploy to staging
      run: |
        echo "Deploying to staging environment..."
        # ì‹¤ì œ ë°°í¬ ëª…ë ¹ì–´ë¡œ êµì²´
        # rsync -avz --delete public/ user@staging-server:/var/www/staging/

    - name: Notify deployment
      run: |
        echo "Staging deployment completed"
        # ìŠ¬ë™, ì´ë©”ì¼ ë“± ì•Œë¦¼ ë°œì†¡

  # í”„ë¡œë•ì…˜ ë°°í¬
  deploy-production:
    needs: [build, security-scan, performance-test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://jyukki.dev
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: blog-build
        path: public/

    - name: Create backup
      run: |
        echo "Creating backup before deployment..."
        # í˜„ì¬ ì‚¬ì´íŠ¸ ë°±ì—…
        # rsync -avz user@prod-server:/var/www/production/ backup/$(date +%Y%m%d_%H%M%S)/

    - name: Deploy to production
      run: |
        echo "Deploying to production environment..."
        # ì‹¤ì œ ë°°í¬ ëª…ë ¹ì–´ë¡œ êµì²´
        # rsync -avz --delete public/ user@prod-server:/var/www/production/

    - name: Health check
      run: |
        echo "Running health checks..."
        # curl -f https://jyukki.dev/health || exit 1

    - name: Notify deployment
      run: |
        echo "Production deployment completed"
        # ìŠ¬ë™, ì´ë©”ì¼ ë“± ì•Œë¦¼ ë°œì†¡

    - name: Update CDN cache
      run: |
        echo "Purging CDN cache..."
        # CDN ìºì‹œ ë¬´íš¨í™”

  # ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼
  monitoring:
    needs: [deploy-production]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
    - name: Setup monitoring
      run: |
        echo "Setting up post-deployment monitoring..."

    - name: Check site availability
      run: |
        for i in {1..5}; do
          if curl -f https://jyukki.dev > /dev/null 2>&1; then
            echo "Site is available"
            break
          fi
          echo "Attempt $i failed, retrying..."
          sleep 10
        done

    - name: Run smoke tests
      run: |
        echo "Running smoke tests..."
        # ê¸°ë³¸ í˜ì´ì§€ ë¡œë“œ í…ŒìŠ¤íŠ¸
        # curl -f https://jyukki.dev/posts/ || exit 1

  # ìë™ ë°±ì—…
  backup:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create content backup
      run: |
        echo "Creating content backup..."
        tar -czf content-backup-$(date +%Y%m%d).tar.gz content/

    - name: Upload backup to storage
      run: |
        echo "Uploading backup to cloud storage..."
        # AWS S3, Google Cloud Storage ë“±ì— ì—…ë¡œë“œ

    - name: Cleanup old backups
      run: |
        echo "Cleaning up old backups..."
        # 30ì¼ ì´ì „ ë°±ì—… íŒŒì¼ ì‚­ì œ

  # ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ ì²´í¬
  dependency-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check Hugo updates
      run: |
        echo "Checking for Hugo updates..."
        LATEST_HUGO=$(curl -s https://api.github.com/repos/gohugoio/hugo/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
        echo "Current: v${{ env.HUGO_VERSION }}, Latest: $LATEST_HUGO"

    - name: Check theme updates
      run: |
        echo "Checking theme updates..."
        cd themes/PaperMod
        git fetch origin
        BEHIND=$(git rev-list --count HEAD..origin/master)
        echo "Theme is $BEHIND commits behind"

    - name: Create update issue
      if: ${{ env.UPDATES_AVAILABLE }}
      run: |
        echo "Creating GitHub issue for available updates..."
        # GitHub APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ìŠˆ ìƒì„±

# ì›Œí¬í”Œë¡œìš° ì™„ë£Œ ì•Œë¦¼
on_success:
  runs-on: ubuntu-latest
  needs: [deploy-production, monitoring]
  if: success()
  steps:
  - name: Success notification
    run: |
      echo "ğŸ‰ Deployment completed successfully!"

on_failure:
  runs-on: ubuntu-latest
  needs: [deploy-production, monitoring]
  if: failure()
  steps:
  - name: Failure notification
    run: |
      echo "âŒ Deployment failed!"
      # ì‹¤íŒ¨ ì•Œë¦¼ ë°œì†¡
